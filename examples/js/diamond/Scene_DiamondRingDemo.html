
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>three.js webgl - loaders - OBJ loader</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>
            body {
                font-family: Monospace;
                background-color: #000;
                color: #fff;
                margin: 0px;
                overflow: hidden;
            }
            #info {
                color: #fff;
                position: absolute;
                top: 10px;
                width: 100%;
                text-align: center;
                z-index: 100;
                display:block;
            }
            #info a, .button { color: #f00; font-weight: bold; text-decoration: underline; cursor: pointer }
        </style>
    </head>

    <body>

        <script src="three/dat.gui.min.js"></script>
        <script src="three/three.js"></script>
        <script src="three/Mirror.js"></script>
        <script src="three/OrbitControls.js"></script>
        <script src="three/Detector.js"></script>
        <script src="three/stats.min.js"></script>
        <script src="three/OBJLoader.js"></script>
        <script src="three/EffectComposer.js"></script>
        <script src="three/RenderPass.js"></script>
        <script src="three/MaskPass.js"></script>
        <script src="three/ShaderPass.js"></script>
        <!--<script src="../../js/lib/three.js/js/postprocessing/BloomPass.js"></script>-->
        <script src="LuminosityHighPassShader.js"></script>
        <script src="ConvolutionShader.js"></script>
        <script src="three/UnrealBloomPass.js"></script>
        <script src="three/FXAAShader.js"></script>
        <script src="three/CopyShader.js"></script>
        <script src="three/DofPass.js"></script>
        <script src="three/ConvolutionShader.js"></script>

        <script src="HDREnvTextureLoader.js"></script>
        <script src="DiamondLoader.js"></script>
        <script src="Sparkle.js"></script>
        <script src="Diamond.js"></script>
        <script src="MaterialLibrary.js"></script>

        <script>

var container, stats;
var camera, backgroundCamera, sceneBackground, scene, renderer, controls;
var groundMirror;
var bFirstFrame = true;
var composer, dpr, effectFXAA, bloomPass, renderScene, renderSceneBg, sceneSparkles, renderSceneSparkles;
var dofPass;
var windowHalfX = window.innerWidth / 2;
var windowHalfY = window.innerHeight / 2;

var cameraPosition = new THREE.Vector3();
var bRotate = true;
var bObjectLoaded = false;
var IsIBLDataRead = false;
var rootNode = new THREE.Object3D();

var library = new MaterialLibrary();
var ringMaterial;
var bDrawSprkles = false;

var sparkleTexture = THREE.ImageUtils.loadTexture( 'textures/sparkle5.png' );
var sparkleTexture1 = THREE.ImageUtils.loadTexture( 'textures/sparkle3.png' );
var noiseTexture = THREE.ImageUtils.loadTexture( 'textures/noiseTexture.jpg' );
var sparkle1 = new Sparkle(sparkleTexture, noiseTexture);
var sparkle2 = new Sparkle(sparkleTexture1, noiseTexture);

var diamondArray = [];
var diamondPrototypeArray = [];

var onReadyCallBack = function() {
    sparkle1.material.uniforms["screenTexture"].value = composer.renderTarget2;
    sparkle2.material.uniforms["screenTexture"].value = composer.renderTarget2;
    bObjectLoaded = true;
};

var onIBLInfoReadyCallBack = function(roughnessArray, uniformTexCoordSetArray) {
    DiamondShader.material.uniforms['TextureCoordSetArray'].value = uniformTexCoordSetArray;
    DiamondShader.material.uniforms['RoughnessArray'].value = roughnessArray;
    IsIBLDataRead = true;
};

var params = {
    "Model": 1,
    "Metal" : 0,
    "Bloom Strength": 1,
    "Bloom Threshold": 0.5,
    "Bloom Radius": 0.0,
    "Metal Roughness": 0.3,
    "Sparkles": false,
    "Rotate": true
};

var envTextureLoader = new HDREnvTextureLoader();
envTextureLoader.loadIBLInfo("textures/IBL_Info.txt", onIBLInfoReadyCallBack);
var envTexture = envTextureLoader.load('textures/mips.png');
envTexture.generateMipmaps = false;
envTexture.magFilter = THREE.LinearFilter;
envTexture.minFilter = THREE.LinearFilter;
var diamondPrototype = new Diamond('designs/diamond_2.obj', envTexture, onReadyCallBack);
diamondPrototype.material.uniforms["squashFactor"].value = 0.95;
diamondPrototype.material.uniforms["normalOffset"].value = 0.1;
diamondPrototype.material.uniforms["rIndexDelta"].value = 0.01;
diamondPrototype.material.uniforms["Key"].value = 1;
// diamondPrototype.material.uniforms["Saturation"].value = 0.45;
// diamondPrototype.material.uniforms["n2"].value = 2.8;
diamondPrototypeArray.push(diamondPrototype);
var metalRing1 = new THREE.Object3D();
var metalRing2 = new THREE.Object3D();

var initRingMaterials = function() {
    library.shaderSource.uniforms['IBLTexture'].value = envTexture;
    library.shaderSource.uniforms['SpecularMap'].value = envTexture;
    library.shaderSource.uniforms['RoughnessMap'].value = envTexture;
    var r = 232/255
    var g = 230/255;
    var b = 230/255;
    library.shaderSource.uniforms['SpecularColor'].value = new THREE.Vector4(r, g, b,1.0);
    library.shaderSource.uniforms['DiffuseColor'].value = new THREE.Vector4(0.01,0.01,0.01,1.0);
    var clonedUniforms1 = THREE.UniformsUtils.clone( library.shaderSource.uniforms );
    clonedUniforms1['IBLTexture'].value = envTexture;
    clonedUniforms1['metalRoughness'].value = 0.1;

    var clonedUniforms2 = THREE.UniformsUtils.clone( library.shaderSource.uniforms );
    clonedUniforms2['IBLTexture'].value = envTexture;
    var r = 212/255
    var g = 175/255;
    var b = 55/255;
    clonedUniforms2['SpecularColor'].value = new THREE.Vector4(r, g, b,1.0);
    clonedUniforms2['metalRoughness'].value = 0.3;

    ringMaterial = new THREE.ShaderMaterial(
            {uniforms:clonedUniforms2,
            extensions:library.shaderSource.extensions,
            vertexShader:library.shaderSource.vertexShader,
            fragmentShader:library.shaderSource.fragmentShader});
    ringMaterial.map = true;
}

initRingMaterials();
initScene();

var onProgress = function ( xhr ) {
        if ( xhr.lengthComputable ) {
                var percentComplete = xhr.loaded / xhr.total * 100;
                console.log( Math.round(percentComplete, 2) + '% downloaded' );
        }
};

var onError = function ( xhr ) {
};

var manager = new THREE.LoadingManager();

manager.onProgress = function ( item, loaded, total ) {
        console.log( item, loaded, total );
};

var loader = new THREE.OBJLoader( manager );
var bRing1Loaded = false, bRing2Loaded = false;

var onRing1Loaded = function(object) {
    metalRing1.add(object);
    object.rotation.x = Math.PI/2;
    object.position.z = -0;
    object.traverse( function ( child ) {
      if ( child instanceof THREE.Mesh ) {
          child.material = ringMaterial;
          child.geometry.computeBoundingSphere();
          var scale = 1/child.geometry.boundingSphere.radius;
          var scaleMatrix = new THREE.Matrix4();
          scaleMatrix.makeScale(scale, scale, scale);
          child.geometry.applyMatrix(scaleMatrix);
      }
    } );
    object.scale.x = 2;
    object.scale.y = 2;
    object.scale.z = 2;

    rootNode.add( metalRing1 );
    var nDiamonds = 1;
    var dTheta = 0.21;
    var theta = -16 * 0.15;
    var radius = 1.88;

    for( var i=0; i<nDiamonds; i++) {
        var copyDiamond = diamondPrototype.shallowCopy();
        copyDiamond.setPosition(0, 1.97, 0);
        // copyDiamond.setRotation(0,12,0);
        copyDiamond.setScale(0.5, 0.6,0.5);
        diamondArray.push(copyDiamond);
        metalRing1.add(copyDiamond.mesh);
        theta += dTheta;
        for(var j=0; j<10; j++) {
            var copySparkle;
            if(j<5)
                copySparkle = sparkle1.shallowCopy();
            else
                copySparkle = sparkle2.shallowCopy();

            var y = 0.0;
            var x = (Math.random() - 0.5)*1.3;
            var z = (Math.random() - 0.5)*1.3;
            copySparkle.setPositionOffset(x, y, z);
            copySparkle.setScale(Math.random()*0.96 + 0.35);
            copySparkle.setRotation(Math.random()*6);
            copySparkle.setIntensity(1.0);
            copyDiamond.addSparkle(copySparkle);
        }
        copyDiamond.applyTransform();
    }
    bRing1Loaded = true;
}

var onRing2Loaded = function(object) {
    metalRing2.add(object);
    object.rotation.x = -Math.PI/2;
    object.position.z = -0.3;
    object.traverse( function ( child ) {
      if ( child instanceof THREE.Mesh ) {
          child.material = ringMaterial;
      }
    } );
    object.scale.x = 0.2;
    object.scale.y = 0.2;
    object.scale.z = 0.2;

    var nDiamonds = 5;
    var dTheta = 0.35;
    var theta = -0.7;
    var radius = 1.9;
    for( var i=0; i<nDiamonds; i++) {
        var copyDiamond = diamondPrototype.shallowCopy();
        copyDiamond.setPosition(radius*Math.sin(theta), radius*Math.cos(theta),-0.3);
        copyDiamond.setRotation(0,0,-theta);
        copyDiamond.setScale(0.45, 0.55,0.45);
        diamondArray.push(copyDiamond);
        metalRing2.add(copyDiamond.mesh);
        theta += dTheta;
        for(var j=0; j<10; j++) {
            var copySparkle;
            if(j<7)
                copySparkle = sparkle1.shallowCopy();
            else
                copySparkle = sparkle2.shallowCopy();

            var y = 0.0;//(Math.random() - 0.5);
            var x = (Math.random() - 0.5)*1.3;//(y+0.5)*2;
            var z = (Math.random() - 0.5)*1.3;//*(y+0.5)*2;
            copySparkle.setPositionOffset(x, y, z);
            copySparkle.setScale(Math.random()*0.96 + 0.35);
            copySparkle.setRotation(Math.random()*6);
            copySparkle.setIntensity(1.0);
            copyDiamond.addSparkle(copySparkle);
            sceneSparkles.add(copySparkle.mesh);
        }
        copyDiamond.applyTransform();
    }
    bRing2Loaded = true;
}

loader.load( 'designs/ring2_uv.obj', onRing1Loaded, onProgress, onError );
loader.load( 'designs/design2.obj', onRing2Loaded, onProgress, onError );

function initScene() {
    container = document.createElement('div');
    document.body.appendChild(container);

    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.3, 100);
    camera.position.z = 8;
    camera.position.y = 0;
    controls = new THREE.OrbitControls(camera, container);
    controls.addEventListener('change', render);
    // scene
    scene = new THREE.Scene();
    scene.add(rootNode);

    renderer = new THREE.WebGLRenderer({preserveDrawingBuffer: true, antialias: false});
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    dpr = 1;
    if (window.devicePixelRatio !== undefined) {
        dpr = window.devicePixelRatio;
    }

    sceneSparkles = new THREE.Scene();

    renderSceneBg = new THREE.RenderPass(sceneBackground, backgroundCamera);
    renderSceneBg.clear = true;
    renderSceneSparkles = new THREE.RenderPass(sceneSparkles, camera);
    renderSceneSparkles.clear = false;
    renderScene = new THREE.RenderPass(scene, camera);
    renderScene.clear = true;
    effectFXAA = new THREE.ShaderPass(THREE.FXAAShader);
    effectFXAA.uniforms['resolution'].value.set(1 / (window.innerWidth * dpr), 1 / (window.innerHeight * dpr));
    effectFXAA.renderToScreen = true;

    bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);//1.0, 9, 0.5, 512);
    dofPass = new THREE.DofPass(new THREE.Vector2(window.innerWidth, window.innerHeight), scene, camera);
    // dofPass.focalDepth = 5.0;
    dofPass.setFocalDepth(3);
    dofPass.NearFarBlurScale = new THREE.Vector2(0.1, 0.15);

    composer = new THREE.EffectComposer(renderer);
    composer.setSize(window.innerWidth * dpr, window.innerHeight * dpr);
    composer.addPass(renderScene);
    // composer.addPass(dofPass);
    composer.addPass(bloomPass);
    composer.addPass(effectFXAA);

    document.addEventListener('mousemove', onDocumentMouseMove, false);
    document.addEventListener('mousedown', onDocumentMouseDown, false);
    document.addEventListener('mouseup', onDocumentMouseUp, false);
    document.addEventListener('mousewheel', onDocumentMouseWheel, false);
    window.addEventListener('resize', onWindowResize, false);

    stats = new Stats();
    stats.domElement.style.position = 'absolute';
    stats.domElement.style.top = '0px';
    container.appendChild(stats.domElement);

    var gui = new dat.GUI();
    gui.add( params, 'Bloom Strength', 0, 3 ).onChange( function(value) {
        bloomPass.strength = Number(value);
    });
    gui.add( params, 'Bloom Threshold', 0, 1 ).onChange( function(value) {
        bloomPass.threshold = Number(value);
    });
    gui.add( params, 'Bloom Radius', 0, 1 ).onChange( function(value) {
        bloomPass.radius = Number(value);
    });
    gui.add( params, 'Metal Roughness', 0, 0.5 ).onChange( function(value) {
        ringMaterial.uniforms[ "metalRoughness" ].value = Number(value);
    });
    gui.add( params, 'Sparkles' ).onChange( function(value) {
        bDrawSprkles = value;
    });
    gui.add( params, 'Rotate' ).onChange( function(value) {
        bRotate = value;
    });
    gui.add( params, 'Model', { Ring1: 0, Ring2: 1 } ).onChange( function( value ) {
           if(Number(value) === 0) {
               rootNode.remove(metalRing1);
               rootNode.add(metalRing2);
           }
           if(Number(value) === 1) {
               rootNode.remove(metalRing2);
               rootNode.add(metalRing1);
           }
    } );
    gui.add( params, 'Metal', { Gold: 0, Platinum: 1 } ).onChange( function( value ) {
           if(Number(value) === 0) {
               var r = 212/255
               var g = 175/255;
               var b = 55/255;
               ringMaterial.uniforms['SpecularColor'].value = new THREE.Vector4(r, g, b,1.0);
           }
           if(Number(value) === 1) {
               var r = 229/255
               var g = 228/255;
               var b = 226/255;
               ringMaterial.uniforms['SpecularColor'].value = new THREE.Vector4(r, g, b,1.0);
           }
    } );

    var Configuration=function(){
            this.color = "#ffffff";
    };
    var conf = new Configuration();

    var controlador = gui.addColor( conf, 'color');
    controlador.onChange( function( colorValue  )
    {
      //the return value by the chooser is like as: #ffff
      colorValue=colorValue.replace( '#','' );
      function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
      var rgba = hexToRgb(colorValue);
      for( var i=0; i<diamondArray.length; i++) {
            var absorbption = diamondArray[i].material.uniforms["Absorbption"].value;
            absorbption.x = 1.0 - rgba.r/255;
            absorbption.y = 1.0 - rgba.g/255;
            absorbption.z = 1.0 - rgba.b/255;
        }
    });

    gui.open();

    animate();
}

function onDocumentMouseMove(event)
{
}

function onDocumentMouseWheel(event)
{
    var pos = camera.position;
    var d = pos.length();
    cameraPosition.x = pos.x;
    cameraPosition.y = pos.y;
    cameraPosition.z = pos.z;
    var min = 1;
    var max = 100;
    if (d < min)
    {
        cameraPosition.normalize();
        pos.x = cameraPosition.x * min;
        pos.y = cameraPosition.y * min;
        pos.z = cameraPosition.z * min;
    }
    if (d > max)
    {
        cameraPosition.normalize();
        pos.x = cameraPosition.x * max;
        pos.y = cameraPosition.y * max;
        pos.z = cameraPosition.z * max;
    }

}

function onDocumentMouseDown(e)
{
}

function onDocumentMouseUp(e)
{
}

function onWindowResize() {
    windowHalfX = window.innerWidth / 2;
    windowHalfY = window.innerHeight / 2;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    effectFXAA.uniforms['resolution'].value.set(1/window.innerWidth, 1/window.innerHeight);
    composer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    requestAnimationFrame(animate);
    if (IsIBLDataRead && bObjectLoaded && bRing1Loaded && bRing2Loaded ) {
        controls.update();
        stats.update();
        for(var i=0; i<diamondArray.length; i++){
          diamondArray[i].alignSparklesWithCamera(camera);
        }
        render();
        if(bRotate) {
          rootNode.rotation.y += 0.00516;
        }
        for(var i=0; i<diamondArray.length; i++){
          diamondArray[i].applyTransform();
        }
    }
}

function render() {
    renderer.autoClear = false;
    renderer.clear();
    renderer.setClearColor(0xcccccc);
    if ( bFirstFrame )
    {
        for(var i=0; i<diamondPrototypeArray.length; i++) {
            diamondPrototypeArray[i].prepareNormalsCubeMap(renderer);
        }
        bFirstFrame = false;
    } else
    {
        composer.render();
        if(bDrawSprkles)
          renderer.render(sceneSparkles, camera);
    }
}

        </script>

    </body>
</html>
